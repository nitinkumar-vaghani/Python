Here is a **very clear, beginner-friendly, step-by-step, deeply explained guide** to **SQLAlchemy ORM basics** — models, sessions, and queries.
This is exactly the foundation you need for modern projects using **FastAPI + SQLAlchemy + Snowflake/Postgres/MySQL**.

I will explain everything from the ground up.

---

# ⭐ **What Is SQLAlchemy ORM?**

SQLAlchemy is the most powerful, flexible, and popular database toolkit in Python.

It has two parts:

### 1. **Core**

SQL expressions, manual queries (like writing SQL with Python).

### 2. **ORM** (Object Relational Mapper)

Represent DB tables as **Python classes**.

ORM lets you:

* Define tables → classes
* Define rows → objects
* Query data → Python objects
* Insert/update → object operations

You write **Python classes instead of SQL**.

This guide focuses on ORM.

---

# ⭐ 1. **Defining Models with SQLAlchemy ORM**

A *model* is a Python class that maps to a database table.

## Step 1 — Import Base

In SQLAlchemy 2.0 style:

```python
from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass
```

Then create your models by inheriting from `Base`.

---

## Step 2 — Define a Model (Table)

Example: User table

```python
from sqlalchemy import Column, Integer, String

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    name = Column(String(100))
    email = Column(String(255), unique=True)
```

This creates a SQL table named `users` with 3 columns.

---

## Step 3 — Create the Database Tables

```python
from sqlalchemy import create_engine

engine = create_engine("sqlite:///app.db")   # example

Base.metadata.create_all(engine)
```

Replace SQLite with Snowflake/Postgres/MySQL later.

---

# ⭐ 2. **Session — How You Communicate with DB**

A session represents a **database connection**.

You use it to:

* insert rows
* update rows
* query rows
* delete rows
* commit/rollback transactions

### Creating a session factory:

```python
from sqlalchemy.orm import sessionmaker

SessionLocal = sessionmaker(bind=engine)
```

### Using a session:

```python
db = SessionLocal()
```

Remember to close when done.

---

# ⭐ 3. **Creating/Inserting Data**

```python
db = SessionLocal()

new_user = User(name="Nitin", email="nitin@example.com")

db.add(new_user)
db.commit()
db.refresh(new_user)  # fetch new ID from DB

print(new_user.id)
```

Key steps:

* `add()` → mark object as pending
* `commit()` → write to DB
* `refresh()` → update object with DB values (primary key)

---

# ⭐ 4. **Querying Data**

SQLAlchemy ORM uses a very Pythonic syntax.

### Query all rows

```python
users = db.query(User).all()
```

### Query first row

```python
user = db.query(User).first()
```

### Filter rows

```python
user = db.query(User).filter(User.email == "nitin@example.com").first()
```

### Filter with multiple conditions

```python
users = db.query(User).filter(
    User.name == "Nitin",
    User.email.contains("@example")
).all()
```

### Order by

```python
users = db.query(User).order_by(User.id.desc()).all()
```

---

# ⭐ 5. **Updating Data**

### Step 1: Fetch object

### Step 2: Modify

### Step 3: Commit

```python
user = db.query(User).filter(User.id == 1).first()
user.name = "New Name"
db.commit()
```

---

# ⭐ 6. **Deleting Data**

```python
user = db.query(User).filter(User.id == 1).first()
db.delete(user)
db.commit()
```

---

# ⭐ 7. **Relationships (Basic)**

### One-to-Many Example

User → Posts

```python
from sqlalchemy.orm import relationship
from sqlalchemy import ForeignKey

class Post(Base):
    __tablename__ = "posts"
    id = Column(Integer, primary_key=True)
    title = Column(String)
    user_id = Column(Integer, ForeignKey("users.id"))

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    name = Column(String)
    posts = relationship("Post", backref="user")
```

Usage:

```python
user = db.query(User).first()
for post in user.posts:
    print(post.title)
```

---

# ⭐ 8. **SQLAlchemy ORM + Async (important for FastAPI)**

SQLAlchemy has an async engine + session:

```python
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from sqlalchemy.orm import sessionmaker

engine = create_async_engine("postgresql+asyncpg://...")

AsyncSessionLocal = sessionmaker(engine, class_=AsyncSession)
```

Async query:

```python
async with AsyncSessionLocal() as session:
    result = await session.execute(select(User))
    users = result.scalars().all()
```

FastAPI async mode uses this style.

---

# ⭐ 9. Using SQLAlchemy in FastAPI (Typical Setup)

### Dependency-based session:

```python
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### Example API route:

```python
@app.get("/users")
def list_users(db: Session = Depends(get_db)):
    return db.query(User).all()
```

This is the **industry-standard** approach.

---

# ⭐ 10. SQLAlchemy Queries (Common Patterns)

### Count rows:

```python
db.query(User).count()
```

### Exists:

```python
db.query(User).filter(User.email == email).first() is not None
```

### IN clause:

```python
users = db.query(User).filter(User.id.in_([1,2,3])).all()
```

### LIKE queries:

```python
users = db.query(User).filter(User.name.like("%nit%")).all()
```

### Join:

```python
db.query(User).join(Post).all()
```

---

# ⭐ 11. SQLAlchemy 2.0 Style (Modern Recommended Syntax)

Newer syntax uses `select()`:

```python
from sqlalchemy import select

stmt = select(User).where(User.id == 1)
result = db.execute(stmt)
user = result.scalars().first()
```

Async version:

```python
result = await session.execute(select(User))
users = result.scalars().all()
```

---

# ⭐ 12. SQLAlchemy ORM + Snowflake Example

Connection:

```python
engine = create_engine(
    "snowflake://<user>:<password>@<account>/<db>/<schema>?warehouse=<warehouse>"
)
```

Query:

```python
db = SessionLocal()
users = db.query(User).all()
```

---

# ⭐ Summary Table

| Concept            | Description                   |
| ------------------ | ----------------------------- |
| **Model**          | Python class → database table |
| **Session**        | DB connection for queries     |
| **add()**          | Insert new record             |
| **commit()**       | Save changes                  |
| **refresh()**      | Fetch updated DB values       |
| **query()**        | Main ORM querying interface   |
| **filter()**       | Add WHERE conditions          |
| **relationship()** | Table associations            |
| **Async ORM**      | For FastAPI async mode        |
| **SQLAlchemy 2.0** | Modern syntax with `select()` |

---
